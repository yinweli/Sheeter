// Code generated by sheeter. DO NOT EDIT.
// Sheeter: https://github.com/yinweli/Sheeter

using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;

namespace Sheeter
{
    /// <summary>
    /// 表格資料
    /// </summary>
    public partial class Sheeter
    {
        public Sheeter(Loader loader)
        {
            this.loader = loader;
        }

        /// <summary>
        /// 讀取資料處理
        /// </summary>
        public async Task<bool> FromData()
        {
            progress.Reset();

            if (loader == null)
                return false;

            var task = new List<Task<bool>>();

            foreach (var itor in new Reader[] { this.ExampleData })
            {
                var tmpl = itor;

                task.Add(
                    Task.Run(() =>
                    {
                        var filename = tmpl.FileName();
                        var data = loader.Load(filename);

                        if (data == null || data.Length == 0)
                            return true;

                        var error = tmpl.FromData(data, true, progress);

                        if (error.Length == 0)
                            return true;

                        loader.Error(filename.File, error);
                        return false;
                    })
                );
            } // for

            var result = await Task.WhenAll(task);

            progress.Complete();
            return result.All(itor => itor);
        }

        /// <summary>
        /// 清除資料
        /// </summary>
        public void Clear()
        {
            progress.Reset();
            this.ExampleData.Clear();
        }

        /// <summary>
        /// 取得進度值
        /// </summary>
        public float Progress()
        {
            return progress.Get();
        }

        /// <summary>
        /// 裝載器物件
        /// </summary>
        private readonly Loader loader;

        /// <summary>
        /// 進度物件
        /// </summary>
        private readonly Progress progress = new();

        /// <summary>
        /// example.xlsx#Data
        /// </summary>
        public readonly ExampleDataReader ExampleData = new();
    }
}
